# SBUS协议分析器使用说明

## 🎯 项目概述

**SBUS协议分析器**是一个功能齐全的SBUS信号分析工具，集成了协议解析和数据记录功能。专为Futaba SBUS信号设计，支持电平取反的硬件实现。

## 📁 文件说明

- **`sbus_analyzer.py`** - 主要的SBUS协议分析器（合并版本）
- **`run_sbus_analyzer.bat`** - 一键启动批处理文件
- **`sbus_data.csv`** - 数据记录文件（运行时生成）

## 🔧 硬件要求

- **串口**: COM3
- **波特率**: 100,000 bps
- **数据位**: 8位
- **校验位**: 偶校验 (Even Parity)
- **停止位**: 2位
- **电平取反**: 已在硬件上实现

## 🚀 快速开始

### 方法一：使用批处理文件（推荐）
1. 双击运行 `run_sbus_analyzer.bat`
2. 选择 `1` 连接COM3
3. 选择 `3` 开始监控
4. 观察SBUS数据解析结果

### 方法二：命令行运行
```bash
# 激活虚拟环境
conda activate serial_debug

# 运行SBUS分析器
python sbus_analyzer.py
```

## 📊 功能特性

### 🔍 协议解析功能
- ✅ 自动检测和连接COM3
- ✅ 实时解析SBUS数据帧
- ✅ 显示16个模拟通道数据（PWM值）
- ✅ 显示2个数字通道状态（CH17, CH18）
- ✅ 监控帧丢失和故障保护状态
- ✅ 实时显示接收统计信息

### 📝 数据记录功能
- ✅ 记录数据到CSV文件
- ✅ 包含时间戳和所有通道数据
- ✅ 便于后续数据分析
- ✅ 支持自定义文件名

### 🎛️ 用户界面
- ✅ 直观的菜单系统
- ✅ 实时数据显示
- ✅ 状态监控
- ✅ 错误处理

## 📋 菜单说明

### 主菜单选项
1. **连接串口** - 以100,000波特率连接串口
2. **开始监控** - 开始实时监控SBUS数据
3. **停止监控** - 停止数据监控
4. **开始记录数据** - 持续接收并记录最新的SBUS数据到CSV文件
5. **停止记录数据** - 停止数据记录
6. **显示当前通道数据** - 接收并显示最后一个完整的SBUS帧
7. **显示连接状态** - 显示连接和统计信息
8. **清屏** - 清除屏幕显示
9. **设置串口号** - 设置要使用的串口端口号
10. **断开连接** - 断开串口连接
11. **退出** - 退出程序

## 📈 数据格式说明

### SBUS帧结构
- **帧长度**: 25字节
- **起始字节**: 0x0F
- **结束字节**: 0x00
- **数据通道**: 16个模拟通道（11位分辨率）
- **数字通道**: 2个数字通道（CH17, CH18）
- **状态位**: 帧丢失、故障保护

### 通道数据范围
- **PWM范围**: 1000-2000微秒
- **SBUS范围**: 172-1811（11位）
- **无效值**: 0（表示通道未使用）

### CSV记录格式
```csv
timestamp,frame_count,error_count,ch1,ch2,...,ch16,ch17,ch18,frame_lost,failsafe
2024-01-01 12:00:00.123,1,0,1500,1500,...,0,False,False,False,False
```

## 🔍 使用示例

### 基本使用流程
1. 确保SBUS信号源已连接到串口
2. 运行程序并选择"设置串口号"（如COM1, COM2, COM3等）
3. 选择"连接串口"连接到指定串口
4. 选择"开始监控"开始接收数据
5. 观察实时解析的通道数据

### 数据记录流程
1. 连接串口
2. 选择"开始记录数据"
3. 输入记录文件名（或使用默认名称）
4. 程序会自动持续接收并记录最新的SBUS数据
5. 数据会实时更新到CSV文件中
6. 使用"停止记录数据"停止记录

### 数据分析流程
1. 停止记录后，CSV文件可用于分析
2. 使用Excel或其他工具打开CSV文件
3. 分析通道数据变化趋势
4. 检查帧丢失和故障保护状态

## ⚠️ 注意事项

1. **串口独占**: 确保COM3没有被其他程序占用
2. **波特率设置**: 必须使用100,000波特率
3. **校验位**: 必须使用偶校验
4. **停止位**: 必须使用2个停止位
5. **电平取反**: 确保硬件已正确实现电平取反
6. **数据记录**: 记录功能需要监控功能同时运行

## 🛠️ 故障排除

### 连接失败
- 检查COM3是否被其他程序占用
- 确认串口参数设置正确
- 检查硬件连接

### 无数据接收
- 确认SBUS信号源正常工作
- 检查波特率设置
- 验证电平取反电路

### 数据解析错误
- 检查SBUS帧格式
- 确认起始和结束字节
- 验证数据完整性

### 记录功能问题
- 确保监控功能已启动
- 检查文件写入权限
- 确认磁盘空间充足

## 📊 数据分析应用

记录的数据可以用于：
- **遥控器校准**: 分析通道中值和范围
- **信号质量分析**: 检查帧丢失率
- **通道映射验证**: 确认通道功能正确
- **故障诊断**: 分析故障保护触发条件
- **性能优化**: 优化信号传输参数

## 🎉 优势特点

### 相比分离版本的优势
- ✅ **一体化设计**: 解析和记录功能集成
- ✅ **简化操作**: 单一程序完成所有功能
- ✅ **统一界面**: 一致的菜单和操作体验
- ✅ **资源优化**: 减少内存和CPU占用
- ✅ **维护便利**: 单一文件便于维护和更新

### 数据记录功能改进
- ✅ **串口设置**: 选项9可设置任意串口号（COM1, COM2, COM3等）
- ✅ **持续记录**: 自动持续接收并记录最新的SBUS数据
- ✅ **实时更新**: 数据实时写入CSV文件，确保记录最新数据
- ✅ **独立线程**: 记录功能在独立线程中运行，不影响其他操作
- ✅ **错误处理**: 记录失败时自动停止，避免文件损坏
- ✅ **文件管理**: 支持自定义文件名和路径

## 🚀 开始使用

现在您可以开始使用功能齐全的SBUS协议分析器了！

1. 双击运行 `run_sbus_analyzer.bat`
2. 按照菜单提示操作
3. 开始分析您的SBUS信号

祝您使用愉快！
